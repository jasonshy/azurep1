<script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
<script>
    const msalConfig = {
        auth: {
            clientId: "6b6d2509-99da-40aa-a826-31fe6d400328",
            authority: "https://login.microsoftonline.com/90f3f200-a8e1-42dc-947a-65f9fc0cd0b4",
            redirectUri: window.location.origin + "/index.html"
        },
        cache: { 
            cacheLocation: "sessionStorage",
            storeAuthStateInCookie: true 
        }
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);

    async function initAuth() {
        try {
            await msalInstance.initialize();
            
            // Check if we are returning from a login attempt
            const isReturningFromAuth = window.location.hash.includes("id_token") || 
                                       window.location.hash.includes("access_token") ||
                                       window.location.hash.includes("code");

            const response = await msalInstance.handleRedirectPromise();
            const accounts = msalInstance.getAllAccounts();

            if (accounts.length > 0) {
                console.log("Logged in!");
                document.body.style.display = "block";
                if (typeof startScanner === "function") startScanner();
            } else if (isReturningFromAuth) {
                console.log("Processing login... waiting.");
                // We are in the middle of logging in, so we stay on the page and wait.
                // If it fails after 3 seconds, then we redirect.
                setTimeout(() => {
                    if (msalInstance.getAllAccounts().length === 0) {
                        window.location.href = "login.html";
                    } else {
                        document.body.style.display = "block";
                    }
                }, 3000);
            } else {
                // Not logged in and not trying to log in? Go to login page.
                window.location.href = "login.html";
            }
        } catch (err) {
            console.error("Auth Error:", err);
            if (!window.location.hash) window.location.href = "login.html";
        }
    }

    initAuth();
</script>
